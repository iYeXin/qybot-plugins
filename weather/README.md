# 天气插件 (weatherPlugin)

一个基于和风天气 API 的天气查询插件，支持通过城市名查询当前天气和未来三天预报。

## 功能特性

- **实时天气查询**：获取指定城市的当前天气状况，包括温度、体感温度、风力、湿度和能见度等详细信息。
- **未来三天预报**：提供未来三天的天气预报，包括白天和夜间的天气状况及温度范围。
- **城市名识别**：支持中文城市名查询，自动匹配对应的城市ID。
- **原神地名支持**：可选功能，支持使用原神游戏中的地名进行天气查询（随机映射到真实城市）。
- **错误处理**：具备完善的错误处理机制，包括API请求失败、超时、JSON解析错误等，并提供友好的错误提示。
- **Gzip解压支持**：自动处理API返回的Gzip压缩数据。

## 使用方法

在群聊或私聊中发送以下命令即可查询天气：

- `@bot 天气 [城市名]`：查询指定城市的天气。
- `/天气 [城市名]`：同上，使用斜杠命令格式。
- `@bot weather [城市名]`：使用英文命令查询天气。
- `/weather [城市名]`：同上，使用斜杠命令格式。

如果未指定城市名，则默认查询北京市的天气。

### 示例

```
用户: @bot 天气 上海
插件: 
🌤️ 上海：当前天气: 多云
🌡️ 温度: 25℃ | 体感: 26℃
💨 东南风 2级
💧 湿度: 70% | 能见度: 10公里
🕒 更新时间: 14:30:00

📅 未来三天预报:

📌 2023-10-27 晴
☀️ 温度: 20~27℃
🌙 夜间: 多云

📌 2023-10-28 晴
☀️ 温度: 19~26℃
🌙 夜间: 多云

📌 2023-10-29 多云
☀️ 温度: 20~25℃
🌙 夜间: 阴
```

## 配置说明

插件使用和风天气 API，需要在 `config.js` 文件中进行配置：

1. **注册和风天气**：访问 [和风天气控制台](https://console.qweather.com/) 注册账号并创建项目。
2. **获取API Key**：在项目中创建凭据（API Key）。
3. **获取API Host**：在控制台设置页面获取你的API Host。
4. **配置文件**：编辑 `plugins/weather/config.js` 文件，填入获取到的API Host和API Key。

```javascript
// plugins/weather/config.js
module.exports = {
    PLUGIN_NAME: "天气插件",
    WEATHER_API_HOST: "https://abcxyz.qweatherapi.com", // 请将abcxyz.qweatherapi.com替换为控制台设置中的API Host
    WEATHER_API_KEY: "xxxxxx", // 请替换为实际API Key
    DEFAULT_LOCATION: "101010100", // 默认北京LocationID
    TIMEOUT: 5000, // 请求超时时间(毫秒)
    GENSHIN_PLACE: false // 是否加入原神地名（随机加载）
};
```

### 原神地名功能

如果希望支持使用原神地名查询天气，可以将 `GENSHIN_PLACE` 设置为 `true`。启用后，插件会将原神地名随机映射到一个真实城市进行天气查询。

## 技术细节

### API 接口

插件使用了和风天气的以下API接口：

- **城市查询**：`/geo/v2/city/lookup` 用于根据城市名获取城市ID。
- **当前天气**：`/v7/weather/now` 用于获取当前天气信息。
- **天气预报**：`/v7/weather/3d` 用于获取未来三天天气预报。

### 数据处理

1. **城市ID映射**：插件通过 `city_id.json` 文件维护城市名到城市ID的映射关系。
2. **原神地名映射**：当启用原神地名功能时，插件通过 `genshin.json` 文件识别原神地名，并随机映射到一个真实城市。
3. **数据格式化**：插件将API返回的JSON数据格式化为易于阅读的文本信息。

## 错误处理

插件具备完善的错误处理机制，能够处理以下情况：

- **网络请求失败**：当API请求失败时，插件会返回错误信息并记录日志。
- **请求超时**：如果API请求超时，插件会返回超时提示。
- **JSON解析错误**：如果API返回的数据无法解析为JSON，插件会返回解析错误信息。
- **API返回错误码**：如果API返回错误码，插件会根据错误码返回相应的错误信息。
- **城市名未找到**：如果输入的城市名无法匹配到任何城市，插件会返回提示信息。

